<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<base target="_top">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Olga Çerçeve — Sipariş Formu</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/lucide-static@0.263.1/font/lucide.min.css" rel="stylesheet">
<style>
  :root {
    --brand: #7c3aed;
    --brand-light: #a78bfa;
    --brand-dark: #5b21b6;
    --accent: #f59e0b;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;
    --bg-primary: #0f0f23;
    --bg-secondary: #1a1a2e;
    --bg-card: rgba(26, 26, 46, 0.8);
    --bg-input: rgba(255, 255, 255, 0.05);
    --text-primary: #ffffff;
    --text-secondary: #a0a0b2;
    --text-muted: #6b6b80;
    --border: rgba(255, 255, 255, 0.1);
    --border-focus: rgba(124, 58, 237, 0.5);
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 16px 64px rgba(0, 0, 0, 0.5);
    --shadow-glow: 0 0 40px rgba(124, 58, 237, 0.3);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --transition-fast: 0.15s ease;
    --transition-normal: 0.3s ease;
    --transition-slow: 0.5s ease;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-primary);
    background: var(--bg-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated Background */
  .bg-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }

  .bg-animation::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at center, rgba(124, 58, 237, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(167, 139, 250, 0.1) 0%, transparent 40%),
                radial-gradient(ellipse at 20% 80%, rgba(245, 158, 11, 0.08) 0%, transparent 40%);
    animation: bgPulse 15s ease-in-out infinite;
  }

  @keyframes bgPulse {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(-2%, -2%) scale(1.05); }
  }

  /* Main Container */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px 16px;
    position: relative;
    z-index: 1;
  }

  /* Glass Card */
  .card {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    padding: 32px;
    animation: cardSlideIn 0.6s ease-out;
  }

  @keyframes cardSlideIn {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 24px;
    margin-bottom: 32px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 16px;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .brand-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: var(--shadow-glow);
  }

  .brand-text h1 {
    font-size: 24px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--brand-light) 0%, var(--brand) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  .brand-text span {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .date-badge {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 8px 16px;
    font-size: 13px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .date-badge i {
    color: var(--brand-light);
  }

  /* Form Grid */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 32px;
  }

  .form-group {
    position: relative;
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
  }

  .form-label i {
    font-size: 14px;
    color: var(--brand-light);
  }

  .form-label .required {
    color: var(--error);
    margin-left: 2px;
  }

  /* Inputs */
  .input-wrapper {
    position: relative;
  }

  .input-wrapper i {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 16px;
    transition: color var(--transition-fast);
    pointer-events: none;
  }

  input, select, textarea {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 14px 16px;
    font-size: 15px;
    font-family: inherit;
    color: var(--text-primary);
    transition: all var(--transition-fast);
    outline: none;
  }

  .input-wrapper input,
  .input-wrapper select {
    padding-left: 44px;
  }

  input:hover, select:hover, textarea:hover {
    border-color: rgba(255, 255, 255, 0.2);
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--brand);
    background: rgba(124, 58, 237, 0.05);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.15);
  }

  .input-wrapper:focus-within i {
    color: var(--brand-light);
  }

  input::placeholder, textarea::placeholder {
    color: var(--text-muted);
  }

  select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b6b80' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    padding-right: 40px;
  }

  select option {
    background: var(--bg-secondary);
    color: var(--text-primary);
    padding: 12px;
  }

  textarea {
    min-height: 100px;
    resize: vertical;
  }

  input[type="number"] {
    font-variant-numeric: tabular-nums;
    text-align: right;
  }

  /* Rate Display */
  .rate-display {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .rate-display input {
    flex: 1;
  }

  .rate-hint {
    background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
    padding: 8px 14px;
    border-radius: var(--radius-md);
    font-size: 12px;
    font-weight: 600;
    color: white;
    white-space: nowrap;
    box-shadow: var(--shadow-sm);
  }

  /* Info Banner */
  .info-banner {
    background: rgba(124, 58, 237, 0.1);
    border: 1px solid rgba(124, 58, 237, 0.2);
    border-radius: var(--radius-md);
    padding: 12px 16px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
    color: var(--text-secondary);
  }

  .info-banner i {
    color: var(--brand-light);
    font-size: 18px;
  }

  .info-banner strong {
    color: var(--text-primary);
  }

  /* Table Section */
  .table-section {
    margin-bottom: 32px;
  }

  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .table-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
  }

  .table-title i {
    color: var(--brand-light);
  }

  .row-count {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 12px;
    font-size: 12px;
    color: var(--text-secondary);
  }

  /* Table Container */
  .table-container {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
  }

  .table-scroll {
    overflow-x: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--brand) transparent;
  }

  .table-scroll::-webkit-scrollbar {
    height: 6px;
  }

  .table-scroll::-webkit-scrollbar-track {
    background: transparent;
  }

  .table-scroll::-webkit-scrollbar-thumb {
    background: var(--brand);
    border-radius: 3px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
  }

  thead {
    background: rgba(124, 58, 237, 0.15);
  }

  th {
    padding: 14px 12px;
    text-align: center;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--brand-light);
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  tbody tr {
    transition: background var(--transition-fast);
  }

  tbody tr:hover {
    background: rgba(124, 58, 237, 0.05);
  }

  tbody tr:not(:last-child) td {
    border-bottom: 1px solid rgba(255, 255, 255, 0.03);
  }

  td {
    padding: 8px;
    text-align: center;
    vertical-align: middle;
  }

  td input, td select {
    padding: 10px 12px;
    font-size: 14px;
    text-align: center;
  }

  td input[type="number"] {
    text-align: right;
    padding-right: 8px;
  }

  /* Column Widths */
  .col-type { min-width: 140px; }
  .col-code { min-width: 200px; }
  .col-unit { min-width: 180px; }
  .col-qty { min-width: 100px; }
  .col-price { min-width: 200px; }
  .col-total { min-width: 140px; }

  /* Glass specific styles */
  .glass-selects {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .glass-selects select {
    width: 100%;
  }

  .glass-plaka {
    display: flex;
    flex-direction: column;
    gap: 4px;
    align-items: center;
  }

  .glass-plaka input {
    width: 100%;
    text-align: center;
  }

  .plaka-m2 {
    font-size: 11px;
    color: var(--brand-light);
    font-weight: 600;
  }

  .glass-price {
    margin-top: 6px;
  }

  .glass-price input {
    width: 100%;
    text-align: center;
  }

  .m2-display {
    font-size: 12px;
    color: var(--accent);
    font-weight: 700;
    margin-top: 4px;
    padding: 4px 8px;
    background: rgba(245, 158, 11, 0.1);
    border-radius: var(--radius-sm);
  }

  .glassType, .glassSize {
    width: 100%;
  }

  /* Price Box */
  .price-box {
    display: flex;
    align-items: center;
    gap: 6px;
    justify-content: center;
  }

  .price-box input {
    width: 80px;
    min-width: 80px;
  }

  .price-eq {
    font-weight: 700;
    color: var(--text-muted);
    font-size: 14px;
  }

  /* Hints */
  .hint {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
    line-height: 1.4;
  }

  .hint strong {
    color: var(--brand-light);
  }

  .price-hint {
    font-size: 10px;
    color: var(--text-muted);
    margin-top: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Line Total */
  .line-total {
    font-weight: 700;
    font-size: 14px;
    color: var(--text-primary);
    font-variant-numeric: tabular-nums;
  }

  /* Footer Section */
  tfoot {
    background: rgba(0, 0, 0, 0.3);
  }

  tfoot td {
    padding: 12px 16px;
    border-top: 1px solid var(--border);
  }

  tfoot tr:first-child td {
    padding-top: 20px;
  }

  .footer-label {
    text-align: right !important;
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 13px;
  }

  .footer-value {
    text-align: center !important;
    font-weight: 700;
    font-size: 15px;
    color: var(--text-primary);
    font-variant-numeric: tabular-nums;
  }

  .footer-grand .footer-label {
    color: var(--accent);
    font-size: 14px;
  }

  .footer-grand .footer-value {
    font-size: 18px;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(245, 158, 11, 0.5);
  }

  /* Discount Input */
  #discountPct {
    width: 80px;
    text-align: center;
  }

  /* Switch */
  .switch-wrapper {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
  }

  .switch-label {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .switch {
    position: relative;
    width: 52px;
    height: 28px;
    display: inline-block;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 20px;
    transition: all var(--transition-normal);
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 2px;
    top: 2px;
    background: var(--text-muted);
    border-radius: 50%;
    transition: all var(--transition-normal);
  }

  .switch input:checked + .slider {
    background: var(--brand);
    border-color: var(--brand);
  }

  .switch input:checked + .slider:before {
    transform: translateX(24px);
    background: white;
  }

  .switch input:focus + .slider {
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
  }

  /* Bottom Section */
  .bottom-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-top: 32px;
  }

  .note-section {
    display: flex;
    flex-direction: column;
  }

  .action-section {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: flex-end;
    gap: 16px;
  }

  /* Submit Button */
  .btn-submit {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    padding: 16px 32px;
    font-size: 15px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: all var(--transition-normal);
    box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
    position: relative;
    overflow: hidden;
  }

  .btn-submit::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
  }

  .btn-submit:hover::before {
    left: 100%;
  }

  .btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(124, 58, 237, 0.5);
  }

  .btn-submit:active {
    transform: translateY(0);
  }

  .btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .btn-submit i {
    font-size: 18px;
  }

  /* Loading Spinner */
  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Status Message */
  .status-message {
    font-size: 14px;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: statusSlide 0.3s ease;
  }

  @keyframes statusSlide {
    from {
      opacity: 0;
      transform: translateX(20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .status-success {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: var(--success);
  }

  .status-error {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: var(--error);
  }

  .status-loading {
    background: rgba(124, 58, 237, 0.15);
    border: 1px solid rgba(124, 58, 237, 0.3);
    color: var(--brand-light);
  }

  /* Toast Notification */
  .toast-container {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .toast {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 16px 20px;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    max-width: 450px;
    animation: toastIn 0.4s ease;
  }

  .toast.toast-out {
    animation: toastOut 0.3s ease forwards;
  }

  @keyframes toastIn {
    from {
      opacity: 0;
      transform: translateX(100px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  @keyframes toastOut {
    to {
      opacity: 0;
      transform: translateX(100px);
    }
  }

  .toast-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .toast-success .toast-icon {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
  }

  .toast-error .toast-icon {
    background: rgba(239, 68, 68, 0.2);
    color: var(--error);
  }

  .toast-content {
    flex: 1;
  }

  .toast-title {
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 2px;
  }

  .toast-message {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .toast-message a {
    color: var(--brand-light);
    text-decoration: none;
  }

  .toast-message a:hover {
    text-decoration: underline;
  }

  .toast-close {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all var(--transition-fast);
  }

  .toast-close:hover {
    background: var(--bg-input);
    color: var(--text-primary);
  }

  /* Hidden Utility */
  .hide {
    display: none !important;
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .form-grid {
      grid-template-columns: 1fr 1fr;
    }

    .form-grid > div:last-child {
      grid-column: 1 / -1;
    }
  }

  @media (max-width: 768px) {
    .container {
      padding: 16px 12px;
    }

    .card {
      padding: 20px 16px;
      border-radius: var(--radius-lg);
    }

    .header {
      flex-direction: column;
      text-align: center;
    }

    .brand {
      flex-direction: column;
    }

    .form-grid {
      grid-template-columns: 1fr;
    }

    .bottom-section {
      grid-template-columns: 1fr;
    }

    .action-section {
      align-items: stretch;
    }

    .btn-submit {
      justify-content: center;
    }

    th, td {
      padding: 8px 6px;
      font-size: 12px;
    }

    .price-box input {
      width: 65px;
      min-width: 65px;
    }

    .toast-container {
      top: auto;
      bottom: 24px;
      left: 12px;
      right: 12px;
    }

    .toast {
      min-width: auto;
      max-width: none;
    }
  }

  @media (max-width: 480px) {
    .brand-text h1 {
      font-size: 20px;
    }

    .table-title {
      font-size: 14px;
    }

    td input, td select {
      padding: 8px 6px;
      font-size: 13px;
    }

    .footer-grand .footer-value {
      font-size: 16px;
    }
  }

  /* Print Styles */
  @media print {
    .bg-animation,
    .btn-submit,
    .toast-container {
      display: none !important;
    }

    body {
      background: white;
      color: black;
    }

    .card {
      box-shadow: none;
      border: 1px solid #ddd;
    }
  }
</style>
</head>
<body>

<!-- Animated Background -->
<div class="bg-animation"></div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Main Container -->
<div class="container">
  <div class="card">

    <!-- Header -->
    <header class="header">
      <div class="brand">
        <div class="brand-icon">◈</div>
        <div class="brand-text">
          <h1>OLGA ÇERÇEVE</h1>
          <span>Sipariş Yönetim Sistemi</span>
        </div>
      </div>
      <div class="header-right">
        <div class="date-badge">
          <i class="lucide-calendar"></i>
          <span id="currentDate"></span>
        </div>
      </div>
    </header>

    <!-- Form Section -->
    <section class="form-grid">
      <div class="form-group">
        <label class="form-label">
          <i class="lucide-user"></i>
          Çalışan <span class="required">*</span>
        </label>
        <div class="input-wrapper">
          <i class="lucide-user-circle"></i>
          <select id="employee">
            <option value="" disabled selected>Seçiniz...</option>
            <option>Razaman Kaypan</option>
            <option>Murat Gündüz</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          <i class="lucide-building-2"></i>
          Müşteri <span class="required">*</span>
        </label>
        <div class="input-wrapper">
          <i class="lucide-briefcase"></i>
          <input id="customer" type="text" placeholder="Müşteri / Firma adı">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">
          <i class="lucide-dollar-sign"></i>
          Dolar Kuru (TL/USD)
        </label>
        <div class="rate-display">
          <input id="rate" type="number" step="0.0001" min="0" value="42.0000" inputmode="decimal">
          <div class="rate-hint" id="rateHint">1 USD = ₺42,00</div>
        </div>
      </div>
    </section>

    <!-- Info Banner -->
    <div class="info-banner">
      <i class="lucide-info"></i>
      <span>Boy/Koli girilse bile hesap <strong>METRE</strong>'ye çevrilir; "Birim" sütununda <strong>mt/adt</strong> olarak gösterilir.</span>
    </div>

    <!-- Table Section -->
    <section class="table-section">
      <div class="table-header">
        <div class="table-title">
          <i class="lucide-package"></i>
          Sipariş Kalemleri
        </div>
        <div class="row-count">
          <span id="activeRows">0</span> / 15 satır aktif
        </div>
      </div>

      <div class="table-container">
        <div class="table-scroll">
          <table id="tbl">
            <thead>
              <tr>
                <th class="col-type">Tür</th>
                <th class="col-code">Kod / Ad / Cam Türü</th>
                <th class="col-unit">Birim / Ölçü</th>
                <th class="col-qty">Miktar / m²</th>
                <th class="col-price">Birim Fiyat (TL)</th>
                <th class="col-total">Satır Tutarı</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="footer-label">Ara Toplam</td>
                <td class="footer-value" id="gross">₺ 0,00</td>
              </tr>
              <tr>
                <td colspan="5" class="footer-label">İndirim (%)</td>
                <td class="footer-value">
                  <input id="discountPct" type="number" min="0" step="0.01" value="0" inputmode="decimal">
                </td>
              </tr>
              <tr id="discRow" class="hide">
                <td colspan="5" class="footer-label">İndirim Tutarı</td>
                <td class="footer-value" id="discountTL">₺ 0,00</td>
              </tr>
              <tr>
                <td colspan="5" class="footer-label">
                  <div class="switch-wrapper">
                    <span class="switch-label">KDV %20 uygula</span>
                    <label class="switch">
                      <input id="vat" type="checkbox">
                      <span class="slider"></span>
                    </label>
                  </div>
                </td>
                <td class="footer-value" id="vatAmount">₺ 0,00</td>
              </tr>
              <tr class="footer-grand">
                <td colspan="5" class="footer-label">Genel Toplam</td>
                <td class="footer-value" id="net">₺ 0,00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>

    <!-- Bottom Section -->
    <section class="bottom-section">
      <div class="note-section">
        <label class="form-label">
          <i class="lucide-message-square"></i>
          Müşteri Notu
        </label>
        <textarea id="note" placeholder="Teslimat, renk, özel talepler..."></textarea>
      </div>

      <div class="action-section">
        <div id="statusContainer"></div>
        <button class="btn-submit" id="sendBtn" type="button">
          <i class="lucide-send"></i>
          <span>Siparişi Gönder</span>
        </button>
      </div>
    </section>

  </div>
</div>

<script>
// Utility Functions
function TL(n) {
  return new Intl.NumberFormat('tr-TR', {
    style: 'currency',
    currency: 'TRY',
    maximumFractionDigits: 2
  }).format(Number(n) || 0);
}

function f2(n) { return (Number(n) || 0).toFixed(2); }
function f4(n) { return (Number(n) || 0).toFixed(4); }
function round2(n) { return Math.round((Number(n) || 0) * 100) / 100; }

function baseCode(s) {
  let x = (s || "").toUpperCase().replace(/\s+/g, ' ').trim();
  x = x.replace(/\bSERISI\b|\bSERİSİ\b/gi, "").trim().replace(/\s+/g, '');
  const i = x.indexOf('-');
  return i > 0 ? x.substring(0, i) : x;
}

// Toast Notification System
function showToast(type, title, message, duration = 5000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;

  const icon = type === 'success' ? 'lucide-check-circle' : 'lucide-alert-circle';

  toast.innerHTML = `
    <div class="toast-icon"><i class="${icon}"></i></div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-message">${message}</div>
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">
      <i class="lucide-x"></i>
    </button>
  `;

  container.appendChild(toast);

  if (duration > 0) {
    setTimeout(() => {
      toast.classList.add('toast-out');
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  return toast;
}

// Set current date
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('tr-TR', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Catalog & DOM Elements
let CATALOG = {};
google.script.run.withSuccessHandler(map => {
  CATALOG = map || {};
  buildRows();
  recalc();
}).getCatalog();

const tbody = document.querySelector("#tbl tbody");
const grossEl = document.getElementById('gross');
const netEl = document.getElementById('net');
const vatEl = document.getElementById('vat');
const vatAmt = document.getElementById('vatAmount');
const rateEl = document.getElementById('rate');
const rateHint = document.getElementById('rateHint');
const discPctEl = document.getElementById('discountPct');
const discRow = document.getElementById('discRow');
const discTL = document.getElementById('discountTL');
const activeRowsEl = document.getElementById('activeRows');

// Cam plaka ölçüleri (cm)
const GLASS_SIZES = {
  mat: [
    { label: "122 × 183 cm", en: 122, boy: 183 }
  ],
  duz: [
    { label: "122 × 183 cm", en: 122, boy: 183 },
    { label: "121 × 161 cm", en: 121, boy: 161 },
    { label: "91,4 × 122 cm", en: 91.4, boy: 122 }
  ]
};

function buildRows() {
  tbody.innerHTML = "";
  for (let i = 0; i < 15; i++) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="col-type">
        <select class="kind">
          <option value="frame">Çerçeve Profili</option>
          <option value="glass">Cam</option>
          <option value="other">Diğer</option>
        </select>
      </td>
      <td class="col-code">
        <input class="codeOrName" placeholder="Ürün kodu / adı">
        <div class="glass-selects hide">
          <select class="glassType">
            <option value="duz">Düz Cam</option>
            <option value="mat">Mat Cam</option>
          </select>
          <select class="glassSize"></select>
        </div>
        <div class="hint"></div>
      </td>
      <td class="col-unit">
        <select class="unit">
          <option value="metre">Metre</option>
          <option value="boy">Boy</option>
          <option value="koli">Koli</option>
        </select>
        <div class="glass-plaka hide">
          <input type="number" class="plaka-adet" step="1" min="1" placeholder="Plaka Adedi" inputmode="numeric" value="1">
          <span class="plaka-m2"></span>
        </div>
      </td>
      <td class="col-qty">
        <input type="number" class="qty" step="0.01" min="0" inputmode="decimal" placeholder="0">
        <div class="m2-display hide"></div>
      </td>
      <td class="col-price">
        <div class="price-box">
          <input type="number" class="tl" step="0.01" min="0" placeholder="TL">
          <span class="price-eq">=</span>
          <input type="number" class="usd" step="0.0001" min="0" placeholder="USD">
        </div>
        <div class="glass-price hide">
          <input type="number" class="m2-price" step="0.01" min="0" placeholder="m² Fiyatı (TL)" inputmode="decimal">
        </div>
        <div class="price-hint"></div>
      </td>
      <td class="col-total">
        <span class="line-total">₺ 0,00</span>
      </td>`;
    tbody.appendChild(tr);
  }
  wireRowEvents();

  // Set first row default
  const first = tbody.querySelector("tr");
  if (first) {
    const c = first.querySelector(".codeOrName");
    c.value = "KS4040-";
    c.dispatchEvent(new Event("input"));
  }
}

function setPrevUnit(tr, u) { tr.dataset.prevUnit = u; }
function getPrevUnit(tr) { return tr.dataset.prevUnit || "metre"; }

let syncing = false;

function wireRowEvents() {
  tbody.querySelectorAll("tr").forEach(tr => {
    const kindEl = tr.querySelector(".kind");
    const codeEl = tr.querySelector(".codeOrName");
    const glassSelectsEl = tr.querySelector(".glass-selects");
    const glassTypeEl = tr.querySelector(".glassType");
    const glassSizeEl = tr.querySelector(".glassSize");
    const unitEl = tr.querySelector(".unit");
    const glassPlakaEl = tr.querySelector(".glass-plaka");
    const plakaAdetEl = tr.querySelector(".plaka-adet");
    const plakaM2El = tr.querySelector(".plaka-m2");
    const qtyEl = tr.querySelector(".qty");
    const m2DisplayEl = tr.querySelector(".m2-display");
    const usdEl = tr.querySelector(".usd");
    const tlEl = tr.querySelector(".tl");
    const m2PriceEl = tr.querySelector(".m2-price");
    const glassPriceEl = tr.querySelector(".glass-price");
    const priceBoxEl = tr.querySelector(".price-box");
    const hintEl = tr.querySelector(".hint");

    setPrevUnit(tr, unitEl.value);
    tr.dataset.prevBase = "";

    // Populate glass size options based on type
    const updateGlassSizes = () => {
      const type = glassTypeEl.value;
      const sizes = GLASS_SIZES[type] || [];
      glassSizeEl.innerHTML = sizes.map((s, i) =>
        `<option value="${i}">${s.label}</option>`
      ).join("");
      updatePlakaInfo();
    };

    // Update plaka m² info
    const updatePlakaInfo = () => {
      const type = glassTypeEl.value;
      const sizeIdx = parseInt(glassSizeEl.value) || 0;
      const sizes = GLASS_SIZES[type] || [];
      const size = sizes[sizeIdx];
      if (size) {
        const m2PerPlaka = round2((size.en * size.boy) / 10000);
        plakaM2El.textContent = `1 plaka = ${f2(m2PerPlaka)} m²`;
      }
    };

    // Calculate total m² for glass
    const calcGlassM2 = () => {
      const type = glassTypeEl.value;
      const sizeIdx = parseInt(glassSizeEl.value) || 0;
      const sizes = GLASS_SIZES[type] || [];
      const size = sizes[sizeIdx];
      const plakaAdet = parseInt(plakaAdetEl.value) || 0;

      if (size && plakaAdet > 0) {
        const m2PerPlaka = round2((size.en * size.boy) / 10000);
        const totalM2 = round2(m2PerPlaka * plakaAdet);
        m2DisplayEl.textContent = `${f2(totalM2)} m²`;
        return { m2PerPlaka, totalM2, size, plakaAdet };
      }
      m2DisplayEl.textContent = "";
      return { m2PerPlaka: 0, totalM2: 0, size: null, plakaAdet: 0 };
    };

    const setHintAndPrice = () => {
      if (kindEl.value === "glass") return; // Glass has its own display

      const rate = parseFloat(rateEl.value) || 0;
      const usd = parseFloat(usdEl.value) || 0;
      const tl = parseFloat(tlEl.value);
      const c = CATALOG[baseCode(codeEl.value)];

      if (kindEl.value === "frame" && c) {
        hintEl.innerHTML = c.type === "metrelik"
          ? `<strong>1 koli = ${c.koliAdet || 0} boy</strong> • <strong>koli: ${f2(c.koliMetre || 0)} m</strong>`
          : `<strong>1 koli = ${c.koliAdet || 0} adet</strong>`;
      } else {
        hintEl.textContent = "";
      }

      const unit = c ? (c.type === "metrelik" ? "m" : "adet") : "m";
      const tlUnit = isFinite(tl) && tlEl.value !== "" ? tl : round2(usd * rate);
      tr.querySelector(".price-hint").textContent = (usd || tlUnit)
        ? `1 ${unit}: ${TL(tlUnit)} (USD ${f4(usd || (rate ? tlUnit / rate : 0))})`
        : "";
    };

    const applyOther = () => {
      unitEl.innerHTML = `<option value="adet">Adet</option>`;
      qtyEl.step = "1";
      qtyEl.inputMode = "numeric";
      const v = parseInt(qtyEl.value || "0", 10);
      qtyEl.value = isFinite(v) && v > 0 ? v : "";
    };

    const applyFrame = (c) => {
      qtyEl.step = "0.01";
      qtyEl.inputMode = "decimal";
      if (c && c.type === "metrelik") {
        unitEl.innerHTML = `<option value="metre">Metre</option><option value="boy">Boy</option><option value="koli">Koli</option>`;
        if (!["metre", "boy", "koli"].includes(unitEl.value)) unitEl.value = "metre";
      } else if (c) {
        unitEl.innerHTML = `<option value="adet">Adet</option><option value="koli">Koli</option>`;
        if (!["adet", "koli"].includes(unitEl.value)) unitEl.value = "adet";
        qtyEl.step = "1";
        qtyEl.inputMode = "numeric";
      } else {
        unitEl.innerHTML = `<option value="metre">Metre</option><option value="boy">Boy</option><option value="koli">Koli</option>`;
      }
    };

    const applyGlass = () => {
      // Show glass-specific elements
      codeEl.classList.add("hide");
      glassSelectsEl.classList.remove("hide");
      unitEl.classList.add("hide");
      glassPlakaEl.classList.remove("hide");
      qtyEl.classList.add("hide");
      m2DisplayEl.classList.remove("hide");
      priceBoxEl.classList.add("hide");
      glassPriceEl.classList.remove("hide");
      hintEl.textContent = "";
      tr.querySelector(".price-hint").textContent = "";

      // Initialize glass dropdowns
      updateGlassSizes();
    };

    const hideGlass = () => {
      // Hide glass-specific elements
      codeEl.classList.remove("hide");
      glassSelectsEl.classList.add("hide");
      unitEl.classList.remove("hide");
      glassPlakaEl.classList.add("hide");
      qtyEl.classList.remove("hide");
      m2DisplayEl.classList.add("hide");
      priceBoxEl.classList.remove("hide");
      glassPriceEl.classList.add("hide");
    };

    const syncFromTL = () => {
      if (syncing || kindEl.value === "glass") return;
      syncing = true;
      const r = parseFloat(rateEl.value) || 0;
      const t = parseFloat(tlEl.value) || 0;
      usdEl.value = r ? f4(t / r) : "";
      syncing = false;
      setHintAndPrice();
      recalc();
    };

    const syncFromUSD = () => {
      if (syncing || kindEl.value === "glass") return;
      syncing = true;
      const r = parseFloat(rateEl.value) || 0;
      const u = parseFloat(usdEl.value) || 0;
      tlEl.value = r ? f2(u * r) : "";
      syncing = false;
      setHintAndPrice();
      recalc();
    };

    const onCode = () => {
      const base = baseCode(codeEl.value);
      if (kindEl.value !== "frame") {
        setHintAndPrice();
        recalc();
        return;
      }

      const prevBase = tr.dataset.prevBase || "";
      const c = CATALOG[base];

      applyFrame(c);

      if (base !== prevBase) {
        if (c && c.priceUSD) {
          usdEl.value = c.priceUSD;
          syncFromUSD();
        } else {
          usdEl.value = "";
          tlEl.value = "";
          tr.querySelector(".line-total").textContent = TL(0);
        }
        tr.dataset.prevBase = base;
      } else {
        setHintAndPrice();
        recalc();
      }
    };

    const onKind = () => {
      if (kindEl.value === "glass") {
        applyGlass();
      } else {
        hideGlass();
        if (kindEl.value === "other") {
          applyOther();
        } else {
          applyFrame(CATALOG[baseCode(codeEl.value)]);
        }
      }
      setHintAndPrice();
      recalc();
    };

    const onUnit = () => {
      const c = CATALOG[baseCode(codeEl.value)];
      const prev = getPrevUnit(tr);
      const next = unitEl.value;
      let q = parseFloat(qtyEl.value) || 0;

      if (kindEl.value === "other") {
        applyOther();
        setPrevUnit(tr, "adet");
        setHintAndPrice();
        recalc();
        return;
      }

      if (kindEl.value === "glass") {
        recalc();
        return;
      }

      if (!c || !q) {
        setPrevUnit(tr, next);
        setHintAndPrice();
        recalc();
        return;
      }

      if (c.type === "metrelik") {
        let metres = 0;
        if (prev === "metre") metres = q;
        else if (prev === "boy") metres = q * (c.boyLength || 0);
        else if (prev === "koli") metres = q * (c.koliMetre || 0);

        if (next === "metre") qtyEl.value = round2(metres);
        else if (next === "boy") qtyEl.value = Math.ceil((c.boyLength ? metres / c.boyLength : 0));
        else if (next === "koli") qtyEl.value = Math.ceil((c.koliMetre ? metres / c.koliMetre : 0));
      }

      setPrevUnit(tr, next);
      setHintAndPrice();
      recalc();
    };

    const onQty = () => {
      if (kindEl.value === "other") {
        const n = qtyEl.value === "" ? "" : Math.max(0, parseInt(qtyEl.value, 10) || 0);
        qtyEl.value = n;
      }
      setHintAndPrice();
      recalc();
    };

    const onGlassTypeChange = () => {
      updateGlassSizes();
      calcGlassM2();
      recalc();
    };

    const onGlassSizeChange = () => {
      updatePlakaInfo();
      calcGlassM2();
      recalc();
    };

    const onPlakaAdetChange = () => {
      calcGlassM2();
      recalc();
    };

    const onM2Price = () => {
      recalc();
    };

    kindEl.addEventListener("change", onKind);
    codeEl.addEventListener("input", onCode);
    glassTypeEl.addEventListener("change", onGlassTypeChange);
    glassSizeEl.addEventListener("change", onGlassSizeChange);
    plakaAdetEl.addEventListener("input", onPlakaAdetChange);
    unitEl.addEventListener("change", onUnit);
    qtyEl.addEventListener("input", onQty);
    tlEl.addEventListener("input", syncFromTL);
    usdEl.addEventListener("input", syncFromUSD);
    m2PriceEl.addEventListener("input", onM2Price);

    onKind();
  });
}

// Update rate hint
function updateRateHint() {
  const r = parseFloat(rateEl.value) || 0;
  rateHint.textContent = `1 USD = ${TL(r)}`;
}

rateEl.addEventListener("input", () => {
  updateRateHint();
  tbody.querySelectorAll("tr").forEach(tr => {
    const usdEl = tr.querySelector(".usd");
    const tlEl = tr.querySelector(".tl");
    if (usdEl.value !== "") {
      const usd = parseFloat(usdEl.value) || 0;
      tlEl.value = f2((parseFloat(rateEl.value) || 0) * usd);
    }
    tr.querySelector(".price-hint").textContent = "";
  });
  recalc();
});

updateRateHint();

// VAT and Discount listeners
vatEl.addEventListener("change", recalc);
discPctEl.addEventListener("input", recalc);

// Recalculate totals
function recalc() {
  const rate = parseFloat(rateEl.value) || 0;
  let gross = 0;
  let activeCount = 0;

  tbody.querySelectorAll("tr").forEach(tr => {
    const kind = tr.querySelector(".kind").value;
    const code = tr.querySelector(".codeOrName").value.trim();
    const unit = tr.querySelector(".unit").value;
    const qty = parseFloat(tr.querySelector(".qty").value) || 0;
    const usd = parseFloat(tr.querySelector(".usd").value) || 0;
    const tlIn = tr.querySelector(".tl").value;

    let line = 0;

    if (kind === "glass") {
      // Glass calculation - plaka based
      const glassType = tr.querySelector(".glassType").value;
      const sizeIdx = parseInt(tr.querySelector(".glassSize").value) || 0;
      const plakaAdet = parseInt(tr.querySelector(".plaka-adet").value) || 0;
      const m2Price = parseFloat(tr.querySelector(".m2-price").value) || 0;

      const sizes = GLASS_SIZES[glassType] || [];
      const size = sizes[sizeIdx];

      if (size && plakaAdet > 0) {
        const m2PerPlaka = round2((size.en * size.boy) / 10000);
        const totalM2 = round2(m2PerPlaka * plakaAdet);

        // Update displays
        tr.querySelector(".plaka-m2").textContent = `1 plaka = ${f2(m2PerPlaka)} m²`;
        tr.querySelector(".m2-display").textContent = `${f2(totalM2)} m²`;

        line = round2(totalM2 * m2Price);
        tr.querySelector(".price-hint").textContent = m2Price > 0
          ? `${plakaAdet} plaka × ${f2(m2PerPlaka)} m² × ${TL(m2Price)}/m²`
          : "";

        activeCount++;
      } else {
        tr.querySelector(".m2-display").textContent = "";
        tr.querySelector(".price-hint").textContent = "";
      }
    } else if (kind === "frame" && code) {
      const c = CATALOG[baseCode(code)];
      const unitTL = tlIn !== "" && isFinite(parseFloat(tlIn))
        ? round2(parseFloat(tlIn))
        : round2((usd || 0) * rate);

      let baseQty = 0;
      if (c?.type === "metrelik") {
        if (unit === "metre") baseQty = qty;
        else if (unit === "boy") baseQty = qty * (c.boyLength || 0);
        else if (unit === "koli") baseQty = qty * (c.koliMetre || 0);
      } else {
        baseQty = qty;
      }

      baseQty = round2(baseQty);
      line = round2(baseQty * unitTL);

      const unitLabel = (c?.type === "metrelik") ? "m" : "m";
      tr.querySelector(".price-hint").textContent = unitTL
        ? `1 ${unitLabel}: ${TL(unitTL)} (USD ${f4(unitTL / (rate || 1))})`
        : "";

      if (qty > 0) activeCount++;
    } else if (kind === "other" && code) {
      const unitTL = round2(parseFloat(tlIn) || 0);
      line = round2((qty || 0) * unitTL);
      tr.querySelector(".price-hint").textContent = unitTL ? `Birim: ${TL(unitTL)}` : "";
      if (qty > 0) activeCount++;
    } else {
      tr.querySelector(".price-hint").textContent = "";
    }

    tr.querySelector(".line-total").textContent = TL(line);
    gross += line;
  });

  // Update active rows count
  activeRowsEl.textContent = activeCount;

  const vPct = Math.max(0, parseFloat(discPctEl.value) || 0);
  const discount = Math.round(gross * vPct) / 100;

  if (discount > 0) {
    discRow.classList.remove('hide');
    discTL.textContent = TL(discount);
  } else {
    discRow.classList.add('hide');
    discTL.textContent = TL(0);
  }

  const after = Math.max(0, gross - discount);
  const vatAmount = vatEl.checked ? Math.round(after * 20) / 100 : 0;
  const net = Math.round((after + vatAmount) * 100) / 100;

  grossEl.textContent = TL(gross);
  vatAmt.textContent = TL(vatAmount);
  netEl.textContent = TL(net);

  return { gross, discountPct: vPct, vatApplied: !!vatEl.checked, vatAmount, net, rate };
}

// Submit handler
document.getElementById("sendBtn").addEventListener("click", () => {
  const btn = document.getElementById("sendBtn");
  const statusContainer = document.getElementById("statusContainer");
  const employee = document.getElementById("employee").value;
  const customer = (document.getElementById("customer").value || "").trim();
  const note = (document.getElementById("note").value || "").trim();

  // Validation
  if (!employee || !customer) {
    showToast('error', 'Eksik Bilgi', 'Çalışan ve Müşteri alanları zorunludur.');
    statusContainer.innerHTML = `
      <div class="status-message status-error">
        <i class="lucide-alert-circle"></i>
        Çalışan ve Müşteri zorunludur.
      </div>`;
    return;
  }

  const rate = parseFloat(rateEl.value) || 0;
  const rows = [];

  tbody.querySelectorAll("tr").forEach(tr => {
    const kind = tr.querySelector(".kind").value;
    const code = (tr.querySelector(".codeOrName").value || "").trim();
    const unit = tr.querySelector(".unit").value;
    const qtyS = (tr.querySelector(".qty").value || "").trim();
    const usdS = (tr.querySelector(".usd").value || "").trim();
    const tlS = (tr.querySelector(".tl").value || "").trim();

    if (kind === "glass") {
      const glassType = tr.querySelector(".glassType").value;
      const sizeIdx = parseInt(tr.querySelector(".glassSize").value) || 0;
      const plakaAdet = parseInt(tr.querySelector(".plaka-adet").value) || 0;
      const m2Price = parseFloat(tr.querySelector(".m2-price").value) || 0;

      const sizes = GLASS_SIZES[glassType] || [];
      const size = sizes[sizeIdx];

      if (size && plakaAdet > 0) {
        const m2PerPlaka = round2((size.en * size.boy) / 10000);
        const totalM2 = round2(m2PerPlaka * plakaAdet);
        const glassName = glassType === "mat" ? "Mat Cam" : "Düz Cam";

        rows.push({
          kind: "glass",
          name: glassName,
          glassType: glassType,
          sizeLabel: size.label,
          en: size.en,
          boy: size.boy,
          plakaAdet: plakaAdet,
          m2PerPlaka: m2PerPlaka,
          m2: totalM2,
          m2Price: m2Price,
          unitPriceTL: m2Price
        });
      }
    } else if (kind === "frame") {
      if (!code) return;
      let usdFinal = usdS;
      if (tlS !== "" && rate) {
        const tlNum = parseFloat(tlS) || 0;
        usdFinal = (tlNum / rate).toFixed(4);
      }
      if (qtyS || usdS || tlS) {
        rows.push({ kind: "frame", fullCode: code, unit, qty: qtyS, usd: usdFinal });
      }
    } else {
      if (!code) return;
      const qi = qtyS ? parseInt(qtyS, 10) : 0;
      rows.push({ kind: "other", name: code, unit: "adet", qty: qi, unitPriceTL: tlS });
    }
  });

  if (!rows.length) {
    showToast('error', 'Boş Sipariş', 'En az bir satır eklemeniz gerekiyor.');
    statusContainer.innerHTML = `
      <div class="status-message status-error">
        <i class="lucide-alert-circle"></i>
        En az bir satır ekleyin.
      </div>`;
    return;
  }

  // Show loading state
  btn.disabled = true;
  btn.innerHTML = `<div class="spinner"></div><span>Gönderiliyor...</span>`;
  statusContainer.innerHTML = `
    <div class="status-message status-loading">
      <div class="spinner"></div>
      Sipariş gönderiliyor...
    </div>`;

  const t = recalc();

  google.script.run
    .withSuccessHandler(res => {
      btn.disabled = false;
      btn.innerHTML = `<i class="lucide-send"></i><span>Siparişi Gönder</span>`;

      if (res && res.ok) {
        const pdfLink = res.pdfUrl
          ? `<a href="${res.pdfUrl}" target="_blank">PDF'i İndir</a>`
          : "";

        showToast('success', 'Sipariş Gönderildi!', `
          Sipariş No: <strong>${res.orderId}</strong><br>
          Toplam: <strong>${TL(res.net)}</strong>
          ${pdfLink ? '<br>' + pdfLink : ''}
        `, 10000);

        statusContainer.innerHTML = `
          <div class="status-message status-success">
            <i class="lucide-check-circle"></i>
            Sipariş #${res.orderId} başarıyla gönderildi!
          </div>`;

        // Reset form
        document.getElementById("employee").value = '';
        document.getElementById("customer").value = '';
        document.getElementById("note").value = '';
        document.getElementById("discountPct").value = "0";
        document.getElementById("vat").checked = false;

        tbody.querySelectorAll("input,select").forEach(el => {
          if (el.id) return;
          if (el.tagName === "SELECT") el.selectedIndex = 0;
          else el.value = "";
        });

        tbody.querySelectorAll(".line-total").forEach(el => el.textContent = TL(0));
        tbody.querySelectorAll(".price-hint").forEach(el => el.textContent = "");
        tbody.querySelectorAll(".hint").forEach(el => el.textContent = "");

        buildRows();
        recalc();

        // Clear status after delay
        setTimeout(() => {
          statusContainer.innerHTML = '';
        }, 5000);

      } else {
        showToast('error', 'Hata Oluştu', res?.error || 'Bilinmeyen bir hata oluştu.');
        statusContainer.innerHTML = `
          <div class="status-message status-error">
            <i class="lucide-alert-circle"></i>
            ${res?.error || 'Bilinmeyen hata'}
          </div>`;
      }
    })
    .withFailureHandler(err => {
      btn.disabled = false;
      btn.innerHTML = `<i class="lucide-send"></i><span>Siparişi Gönder</span>`;

      showToast('error', 'Sunucu Hatası', String(err));
      statusContainer.innerHTML = `
        <div class="status-message status-error">
          <i class="lucide-alert-circle"></i>
          Sunucu hatası: ${String(err)}
        </div>`;
    })
    .submitFromHtml({
      employee,
      customer,
      note,
      rate: t.rate,
      vatApplied: t.vatApplied,
      discountPct: t.discountPct,
      rows
    });
});
</script>
</body>
</html>
